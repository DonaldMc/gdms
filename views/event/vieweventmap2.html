{{left_sidebar_enabled,right_sidebar_enabled=False,False}}
{{extend 'layout.html'}}
{{from jointjs2py import portangle,linkangle,rectangle,addobjects,newmetlink,initgraph}}
{{from ndsfunctions import truncquest}}

{{include 'event\eventdetails.i'}}

<script>
    var myJSON = {{=XML(cellsjson)}};
    var cellsjson = {cells: myJSON};
    var linkarray ={{=XML(linkarray)}};
</script>


<div id="paper-link-out"></div>

<div id="ajaxlink"></div>

<div id="map"></div>  

<p>{{=resultstring}}</p>

<p><INPUT TYPE=BUTTON  class="btn btn-primary btn-sm btn-group-sm" onclick="parent.location='{{=URL('submit','new_question', args=['quest'],extension='html')}}'" VALUE="New Question">
    <INPUT TYPE=BUTTON class="btn btn-primary btn-sm btn-group-sm" onClick="parent.location='{{=URL('network','index')}}'" VALUE="Show as Network">
{{if (eventrow.shared == True) or (eventrow.owner == auth.user_id):}}
<INPUT TYPE=BUTTON class="btn btn-primary btn-sm btn-group-sm" onClick="parent.location='{{=URL('eventaddquests',args=[eventid])}}'" VALUE="Link Questions">
{{pass}}
</p>

{{include 'event\eventitems.i'}}


<script type="text/javascript">

jQuery(document).ready(function(){


    {{=initgraph(1000,1000)}}


    joint.shapes.custom = {};
    // The following custom shape creates a link out of the whole element.
    joint.shapes.custom.ElementLink = joint.shapes.devs.Model.extend({
    // Note the `<a>` SVG element surrounding the rest of the markup.
    markup: '<a><g class="rotatable"><g class="scalable"><rect/></g><text/></g></a>',
    defaults: joint.util.deepSupplement({
        type: 'custom.ElementLink'
    }, joint.shapes.devs.Model.prototype.defaults)
    });


    joint.shapes.custom = {};
    // The following custom shape creates a link out of the whole element.
    joint.shapes.custom.ElementLink = joint.shapes.basic.Rect.extend({
    // Note the `<a>` SVG element surrounding the rest of the markup.
    markup: '<a><g class="rotatable"><g class="scalable"><rect/></g><text/></g></a>',
    defaults: joint.util.deepSupplement({
        type: 'custom.ElementLink'
    }, joint.shapes.basic.Rect.prototype.defaults)
    });

    graph.fromJSON(cellsjson);

    for	(index = 0; index < linkarray.length; index++) {
    paper.findViewByModel(linkarray[index]).set('router', { name: 'metro' });
    paper.findViewByModel(linkarray[index]).set('connector', { name: 'rounded', args: { radius: 60 }});
    }

    
    graph.on('change:source change:target', function(link) {
    var sourcePort = link.get('source').port;
    var sourceId = link.get('source').id;
    var targetPort = link.get('target').port;
    var targetId = link.get('target').id;

    var m = [
        'The port <b>' + sourcePort,
        '</b> of element with ID <b>' + sourceId,
        '</b> is connected to port <b>' + targetPort,
        '</b> of elemnt with ID <b>' + targetId + '</b>'
    ].join('');


    if (targetId.substr(0,3) != 'und') {
    requestLink(sourceId,targetId);
    };
    out(m);

});

    graph.on('change:position', function(element) {
    var sourceId = element.id;
    var sourceposx = element.get('position')['x'];
    var sourceposy = element.get('position')['y'];

    var m = ['The element moved' ,
    sourceId,
    '   ' + sourceposx,
    '   ' + sourceposy ].join('');
    moveElement(sourceId, sourceposx, sourceposy);
    out(m);
});

graph.on('remove', function(cell) {
    console.log('event: remove');
    if (cell instanceof joint.dia.Link) {
        var sourceId = cell.get('source').id;
        var targetId = cell.get('target').id;
        var m = [
        'The element with ID <b>' + sourceId,
        '</b> is reomved from elemnt with ID <b>' + targetId + '</b>'
    ].join('');

    if (targetId.substr(0,3) != 'und') {
    deleteLink(sourceId,targetId);
    };

    out(m);
    }
});

function out(m) {
    $('#paper-link-out').html(m);
};

function requestLink(sourceId, targetId)
{
    ajax('{{=URL('network','linkrequest')}}'+'/'+sourceId+'/'+targetId+'/', ['bla'], 'ajaxlink');
};

function deleteLink(sourceId, targetId)
{
    ajax('{{=URL('network','linkrequest')}}'+'/'+sourceId+'/'+targetId+'/delete/', ['bla'], 'ajaxlink');
};

function moveElement(sourceId, sourceposx, sourceposy)
{
    ajax('{{=URL('event','move')}}'+'/'+{{=eventrow.id}}+'/'+sourceId+'/'+sourceposx+'/'+sourceposy+'/', ['bla'], 'ajaxlink');
};

});

</script>





 




